From fe0bff3edb94f60ecf12a67957880ab2f9097555 Mon Sep 17 00:00:00 2001
From: Valentina Fernandez <valentina.fernandezalanis@microchip.com>
Date: Tue, 3 Aug 2021 10:53:03 +0100
Subject: [PATCH 53/93] riscv: icicle kit: update amp dts to hw design
 Signed-off-by: Valentina Fernandez <valentina.fernandezalanis@microchip.com>

---
 .../microchip-mpfs-icicle-kit-context-a.dts   | 138 +++++++++++-------
 arch/riscv/configs/icicle_kit_amp_defconfig   |  37 ++++-
 2 files changed, 121 insertions(+), 54 deletions(-)

diff --git a/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts b/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts
index 30618e738ed9..2a7895d7d447 100644
--- a/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts
+++ b/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts
@@ -285,53 +285,53 @@ serial3: serial@20104000 {
 			status = "disabled";
 		};
 		emmc: mmc@20008000 { /* Common node entry for emmc/sd */
-		    compatible = "cdns,sd4hc";
-		    reg = <0x0 0x20008000 0x0 0x1000>;
-		    interrupt-parent = <&L1>;
-		    interrupts = <88 89>;
-		    pinctrl-names = "default";
-		    clocks = <&clkcfg CLK_MMC>;
-		    bus-width = <4>;
-		    cap-mmc-highspeed;
-		    cap-sd-highspeed;
-		    no-1-8-v;
-		    disable-wp;
-		    max-frequency = <200000000>;
-		    status = "okay";
+			compatible = "cdns,sd4hc";
+			reg = <0x0 0x20008000 0x0 0x1000>;
+			interrupt-parent = <&L1>;
+			interrupts = <88 89>;
+			pinctrl-names = "default";
+			clocks = <&clkcfg CLK_MMC>;
+			bus-width = <4>;
+			cap-mmc-highspeed;
+			cap-sd-highspeed;
+			no-1-8-v;
+			disable-wp;
+			max-frequency = <200000000>;
+			status = "okay";
 		};
 		emac1: ethernet@20112000 {
-            compatible = "cdns,macb";
-            reg = <0x0 0x20112000 0x0 0x2000>;
-            interrupt-parent = <&L1>;
-            interrupts = <70 71 72 73>;
-            mac-address = [56 34 12 00 FC 01];
-            phy-mode = "sgmii";
-            clocks = <&clkcfg CLK_MAC1>, <&clkcfg CLK_AHB>;
-            clock-names = "pclk", "hclk";
-            #address-cells = <1>;
-            #size-cells = <0>;
-            phy-handle = <&phy1>;
-            phy1: ethernet-phy@9 {
-                reg = <9>;
-                ti,fifo-depth = <0x01>;
-            };
-            phy0: ethernet-phy@8 {
-                reg = <8>;
-                ti,fifo-depth = <0x01>;
-            };
-        };
-        emac0: ethernet@20110000 {
-            compatible = "cdns,macb";
-            reg = <0x0 0x20110000 0x0 0x2000>;
-            interrupt-parent = <&L1>;
-            interrupts = <64 65 66 67>;
-            mac-address = [56 34 12 00 FC 02];
-            phy-mode = "sgmii";
-            clocks = <&clkcfg CLK_MAC0>, <&clkcfg CLK_AHB>;
-            clock-names = "pclk", "hclk";
-            phy-handle = <&phy0>;
-        };
-		pcie: pcie@70000000 {
+			compatible = "cdns,macb";
+			reg = <0x0 0x20112000 0x0 0x2000>;
+			interrupt-parent = <&L1>;
+			interrupts = <70 71 72 73>;
+			mac-address = [56 34 12 00 FC 01];
+			phy-mode = "sgmii";
+			clocks = <&clkcfg CLK_MAC1>, <&clkcfg CLK_AHB>;
+			clock-names = "pclk", "hclk";
+			#address-cells = <1>;
+			#size-cells = <0>;
+			phy-handle = <&phy1>;
+			phy1: ethernet-phy@9 {
+				reg = <9>;
+				ti,fifo-depth = <0x01>;
+			};
+			phy0: ethernet-phy@8 {
+				reg = <8>;
+				ti,fifo-depth = <0x01>;
+			};
+		};
+		emac0: ethernet@20110000 {
+			compatible = "cdns,macb";
+			reg = <0x0 0x20110000 0x0 0x2000>;
+			interrupt-parent = <&L1>;
+			interrupts = <64 65 66 67>;
+			mac-address = [56 34 12 00 FC 02];
+			phy-mode = "sgmii";
+			clocks = <&clkcfg CLK_MAC0>, <&clkcfg CLK_AHB>;
+			clock-names = "pclk", "hclk";
+			phy-handle = <&phy0>;
+		};
+		pcie: pcie@43000000 {
 			#address-cells = <0x3>;
 			#interrupt-cells = <0x1>;
 			#size-cells = <0x2>;
@@ -347,12 +347,12 @@ pcie: pcie@70000000 {
 			interrupt-map-mask = <0 0 0 7>;
 			interrupt-parent = <&L1>;
 			interrupts = <119>;
-			ranges = <0x03000000 0x0 0x78000000 0x0 0x78000000 0x0 0x04000000>;
-			reg = <0x0 0x70000000 0x0 0x08000000 0x0 0x43000000 0x0 0x00010000>;
-			dma-ranges = <0x02000000 0x0 0x00000000 0x0 0x00000000 0x1 0x00000000>;
+			ranges = <0x03000000 0x0 0x08000000 0x20 0x08000000 0x0 0x80000000>;
+			reg = <0x20 0x00000000 0x0 0x08000000 0x0 0x43000000 0x0 0x00010000>;
 			reg-names = "cfg", "apb";
 			msi-parent = <&pcie>;
 			msi-controller;
+			mchp,axi-m-atr0 = <0x10 0>;
 			status = "okay";
 			pcie_intc: interrupt-controller {
 				#address-cells = <0>;
@@ -429,16 +429,52 @@ msscan: can@2010c000 {
 			clocks = <&clkcfg CLK_CAN0>;
 			status = "okay";
 		};
-		uio_lsram: uio_lpddr4@0xC0000000 {
+		mssspi0: spi@20108000 {
+			compatible = "microsemi,ms-pf-mss-spi";
+			interrupt-parent = <&L1>;
+			interrupts = <54>;
+			reg = <0x0 0x20108000 0 0x1000>;
+			clocks = <&clkcfg CLK_SPI0>;
+			spi-max-frequency = <25000000>;
+			#address-cells = <1>;
+			#size-cells = <0>;
+			num-cs = <1>;
+			status = "okay";
+		};
+		mssspi1: spi@20109000 {
+			compatible = "microsemi,ms-pf-mss-spi";
+			interrupt-parent = <&L1>;
+			interrupts = <55>;
+			reg = <0x0 0x20109000 0 0x1000>;
+			clocks = <&clkcfg CLK_SPI1>;
+			spi-max-frequency = <25000000>;
+			#address-cells = <1>;
+			#size-cells = <0>;
+			num-cs = <1>;
+			status = "disabled";
+		};
+		mssqspi: qspi@21000000 {
+			compatible = "microsemi,ms-pf-mss-qspi";
+			interrupt-parent = <&L1>;
+			interrupts = <85>;
+			reg = <0x20 0x21000000 0 0x1000>;
+			clocks = <&clkcfg CLK_QSPI>;
+			spi-max-frequency = <25000000>;
+			#address-cells = <1>;
+			#size-cells = <0>;
+			num-cs = <1>;
+			status = "okay";
+		};
+		fpgalsram: fpga_lsram@0x61000000 {
 			compatible = "generic-uio";
 			reg = < 0x0 0x61000000 0x0 0x00010000
 					0x14 0x00000000 0x0 0x00010000 >;
 			status = "okay";
 		};
-		dma: dma@0x60020000 {
+		fpgadma: dma@0x60020000 {
 			#address-cells = <1>;
 			#size-cells = <0>;
-			compatible = "microsemi,ms-pf-mss-dma-uio";
+			compatible = "microchip,mpfs-fpga-dma-uio";
 			reg = <0x00 0x60020000 0x0 0x1000>;
 			interrupt-parent = <&L1>;
 			interrupts = <120>;
diff --git a/arch/riscv/configs/icicle_kit_amp_defconfig b/arch/riscv/configs/icicle_kit_amp_defconfig
index ee83f30c9203..afb8025cea1b 100644
--- a/arch/riscv/configs/icicle_kit_amp_defconfig
+++ b/arch/riscv/configs/icicle_kit_amp_defconfig
@@ -77,10 +77,10 @@ CONFIG_VIRTIO_CONSOLE=y
 CONFIG_HW_RANDOM=y
 CONFIG_HW_RANDOM_VIRTIO=y
 CONFIG_SPI=y
-CONFIG_SPI_MASTER=y
 CONFIG_SPI_SIFIVE=y
 CONFIG_SPI_MICROSEMI=y
 CONFIG_SPI_MICROSEMI_QSPI=y
+CONFIG_SPI_MASTER=y
 CONFIG_GPIOLIB=y
 CONFIG_GPIOLIB_IRQCHIP=y
 CONFIG_OF_GPIO=y
@@ -101,6 +101,16 @@ CONFIG_USB_OHCI_HCD=y
 CONFIG_USB_OHCI_HCD_PLATFORM=y
 CONFIG_USB_STORAGE=y
 CONFIG_USB_UAS=y
+CONFIG_USB_SUPPORT=y
+CONFIG_USB_INVENTRA_DMA=y
+CONFIG_USB_MUSB_HDRC=y
+CONFIG_USB_MUSB_HOST=y
+CONFIG_NOP_USB_XCEIV=y
+CONFIG_MEDIA_SUPPORT=y
+CONFIG_MEDIA_CAMERA_SUPPORT=y
+CONFIG_MEDIA_USB_SUPPORT=y
+CONFIG_USB_VIDEO_CLASS=y
+CONFIG_USB_MUSB_MPFS_MICROCHIP=y
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_SDHCI_PLTFM=y
 CONFIG_MMC_SDHCI_CADENCE=y
@@ -164,12 +174,33 @@ CONFIG_POLARFIRE_SOC_SYS_CTRL=y
 CONFIG_HW_RANDOM_POLARFIRE_SOC=y
 CONFIG_RTC_DRV_MPFS=y
 CONFIG_I2C_MICROCHIP=y
+CONFIG_PAC193X=y
+
+CONFIG_BLK_DEV_ZONED=y
+CONFIG_BLK_DEV_NVME=y
 
 CONFIG_PWM=y
-CONFIG_PWM_DEBUG=y
 CONFIG_PWM_MICROCHIP_CORE=y
 
 CONFIG_POLARFIRE_SOC_SERIAL_NUMBER=y
 CONFIG_POLARFIRE_SOC_FPGA_DIGEST=y
 CONFIG_POLARFIRE_SOC_SIGNATURE=y
-CONFIG_POLARFIRE_SOC_FPGA_CERT=y
\ No newline at end of file
+CONFIG_POLARFIRE_SOC_FPGA_CERT=y
+
+CONFIG_U_DMA_BUF=y
+CONFIG_UIO=y
+CONFIG_UIO_PDRV_GENIRQ=y
+CONFIG_UIO_DMEM_GENIRQ=y
+CONFIG_UIO_MICROCHIP_CAN=y
+CONFIG_UIO_MICROCHIP_PDMA=y
+CONFIG_UIO_MICROSEMI_DMA=y
+
+CONFIG_IIO_BUFFER=y
+CONFIG_IIO_CONFIGFS=y
+CONFIG_IIO_CONSUMERS_PER_TRIGGER=2
+CONFIG_IIO_KFIFO_BUF=y
+CONFIG_IIO_SW_DEVICE=y
+CONFIG_IIO_SW_TRIGGER=y
+CONFIG_IIO_TRIGGERED_BUFFER=y
+CONFIG_IIO_TRIGGER=y
+CONFIG_IIO=y
\ No newline at end of file
-- 
2.30.2

