From 8cc760333bcbd8b9aa8c8fb3bb6c70477f294da4 Mon Sep 17 00:00:00 2001
From: Valentina Fernandez <valentina.fernandezalanis@microchip.com>
Date: Thu, 28 Oct 2021 13:49:32 +0100
Subject: [PATCH 74/93] riscv: dts: mpfs: add ihc support

---
 .../bindings/mailbox/microchip,miv-ihc.yaml   | 60 +++++++++++++++++++
 .../dts/microchip/microchip-mpfs-fabric.dtsi  |  9 +++
 .../microchip-mpfs-icicle-kit-context-a.dts   |  4 ++
 .../boot/dts/microchip/microchip-mpfs.dtsi    |  1 +
 include/dt-bindings/mailbox/miv-ihc.h         | 19 ++++++
 5 files changed, 93 insertions(+)
 create mode 100644 Documentation/devicetree/bindings/mailbox/microchip,miv-ihc.yaml
 create mode 100644 include/dt-bindings/mailbox/miv-ihc.h

diff --git a/Documentation/devicetree/bindings/mailbox/microchip,miv-ihc.yaml b/Documentation/devicetree/bindings/mailbox/microchip,miv-ihc.yaml
new file mode 100644
index 000000000000..1187502a65af
--- /dev/null
+++ b/Documentation/devicetree/bindings/mailbox/microchip,miv-ihc.yaml
@@ -0,0 +1,60 @@
+# SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)
+%YAML 1.2
+---
+$id: "http://devicetree.org/schemas/mailbox/microchip,miv-ihc.yaml#"
+$schema: "http://devicetree.org/meta-schemas/core.yaml#"
+
+title: Microchip PolarFire Mi-V Inter-hart communication (IHC) driver
+
+maintainers:
+  - Valentina Fernandez <valentina.fernandezalanis@microchip.com>
+  - Conor Dooley <Conor Dooley <conor.dooley@microchip.com>>
+
+description: |
+  The Mi-V Inter-hart Communication (IHC) subsystem is used to exchage
+  data between harts in PolarFire SoC. It provides the ability to
+  send messages (ie. data, status and control) and coordinate between
+  harts through a non-blocking interrupt signaling mechanism.
+
+properties:
+  compatible:
+    const: microchip,miv-ihc
+
+  interrupts:
+    description: Should contain the IHC interrupt associated with the lowest
+    hart ID in the local software context.
+    maxItems: 1
+
+  miv-ihc,remote-context-id:
+    $ref: /schemas/types.yaml#/definitions/uint32
+    enum: [5, 6]
+    description: |
+      ID of the software context where data should be sent to.
+      Should be either a value of 5 (Context A) or 6 (Context B).
+      A default value of 6 should be used to match default IHC configuration 
+      (Linux on context A and RTOS/BM on context B).
+
+  "#mbox-cells":
+    const: 1
+
+required:
+  - compatible
+  - interrupts
+  - "#mbox-cells"
+  - miv-ihc,remote-context-id
+
+additionalProperties: false
+
+examples:
+  - |
+    soc {
+      #address-cells = <2>;
+      #size-cells = <2>;
+      ihc: ihc {
+        compatible = "microchip,miv-ihc";
+        interrupt-parent = <&plic>;
+        interrupts = <IHC_HART1_INT>;
+        miv-ihc,remote-context-id = <IHC_CONTEXT_B>;
+        #mbox-cells = <1>;
+      };
+    };
diff --git a/arch/riscv/boot/dts/microchip/microchip-mpfs-fabric.dtsi b/arch/riscv/boot/dts/microchip/microchip-mpfs-fabric.dtsi
index 4b370690292b..8b128b83e706 100644
--- a/arch/riscv/boot/dts/microchip/microchip-mpfs-fabric.dtsi
+++ b/arch/riscv/boot/dts/microchip/microchip-mpfs-fabric.dtsi
@@ -18,5 +18,14 @@ fpgalsram: fpga_lsram@61000000 {
 			0x14 0x00000000 0x0 0x00010000>;
 		status = "okay";
 	};
+
+	ihc: ihc {
+		compatible = "microchip,miv-ihc";
+		interrupt-parent = <&plic>;
+		interrupts = <IHC_HART1_INT>;
+		miv-ihc,remote-context-id = <IHC_CONTEXT_B>;
+		#mbox-cells = <1>;
+		status = "disabled";
+	};
 };
 
diff --git a/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts b/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts
index 1aff012f9d5a..bb0ebce14e39 100644
--- a/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts
+++ b/arch/riscv/boot/dts/microchip/microchip-mpfs-icicle-kit-context-a.dts
@@ -253,6 +253,10 @@ &pcie {
 	status = "okay";
 };
 
+&ihc {
+	status = "okay";
+};
+
 &cpu4 {
 	status = "disabled"; // in use by context b
 };
diff --git a/arch/riscv/boot/dts/microchip/microchip-mpfs.dtsi b/arch/riscv/boot/dts/microchip/microchip-mpfs.dtsi
index 897bac37e7fb..a4f357b956a4 100644
--- a/arch/riscv/boot/dts/microchip/microchip-mpfs.dtsi
+++ b/arch/riscv/boot/dts/microchip/microchip-mpfs.dtsi
@@ -4,6 +4,7 @@
 #include "dt-bindings/clock/microchip,mpfs-clock.h"
 #include "dt-bindings/interrupt-controller/microchip,mpfs-plic.h"
 #include "dt-bindings/interrupt-controller/riscv-hart.h"
+#include "dt-bindings/mailbox/miv-ihc.h"
 #include "microchip-mpfs-fabric.dtsi"
 
 / {
diff --git a/include/dt-bindings/mailbox/miv-ihc.h b/include/dt-bindings/mailbox/miv-ihc.h
new file mode 100644
index 000000000000..953754aa2291
--- /dev/null
+++ b/include/dt-bindings/mailbox/miv-ihc.h
@@ -0,0 +1,19 @@
+/* SPDX-License-Identifier: GPL-2.0 OR BSD-2-Clause */
+/*
+ * Copyright (c) 2021 Microchip Technology Inc. All rights reserved.
+ */
+
+#ifndef __DT_BINDINGS_MIV_IHC_H
+#define __DT_BINDINGS_MIV_IHC_H
+
+#include "dt-bindings/interrupt-controller/microchip,mpfs-plic.h"
+
+#define IHC_CONTEXT_A	5
+#define IHC_CONTEXT_B	6
+
+#define IHC_HART1_INT  PLIC_INT_FABRIC_F2H_62
+#define IHC_HART2_INT  PLIC_INT_FABRIC_F2H_61
+#define IHC_HART3_INT  PLIC_INT_FABRIC_F2H_60
+#define IHC_HART4_INT  PLIC_INT_FABRIC_F2H_59
+
+#endif
-- 
2.30.2

